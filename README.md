
# Gain_sampler

## Requirements

The `return_more_vals`branch of `hera_cal` must be used. It returns extra values that are needed for bluecal.

`analyse_sims.py` needs to dump the  redcal cal_dict.npz file in `hickle` format, because the current format doesn't seem to dump everything. This is a simple code change you can make to the script. Install `hickle` using `pip`, import it into the script, and change

```
np.savez(input_ext+'_cal_dict.npz',**cal)
```
to 
```
hkl.dump(cal, input_ext+'_cal_dict.npz')
```

## Caveats

The code dumps plots to files, which makes it unsuitable for running in a notebook. (TODO: make it usable in a notebook).

## Running gain perturbation simulations

These run both the GLS and MCMC and attempt to find gain offsets ("x" values) that will produce the best calibration of observed visibilities. 

1. Generate simulated visibilities, model, gains, gain offsets that are perfectly calibrated.
2. Perturb the gains by some fixed percentage.
3. Apply GLS or MCMC to obtain new gain offsets ("x" values)
4. Evaluate the calibration.

### What it means to evaluate the result

When gains are perturbed, the x values are changed to compensate, so as to recover perfect calibration. For the GLS, this means that `gi*conj(gj)*(1+xi+conj(xj))` should be the same at steps 1. and 3. above. This is the comparison that is made, and it's done visually by generating plots. See "GLS perturbations.pdf".

### Run

`python perturbation_sims.py`

It is not setup for a notebook and should be run on a cluster (unless you cut down the number of sims).

## Running bluecal

 `bluecal` is setup to use the output of the `non-redundant-pipeline`. It is run with the file path referring to a non-redundant "case". It will use that path to select  files from the simulation based on their extension. For example:

```
python bluecal.py non-redundant-pipeline/points_sim/viscatBC_stretch0.02
```

This will use the following files:

viscatBC_stretch0.02.uvh5
:  Contains the model visibilities.

viscatBC_stretch0.02.calfits
: Contains the gains applied to the model.

viscatBC_stretch0.02_g.uvh5
:  Contains the "observed" visibilities after applying the gains and noise to the model.

viscatBC_stretch0.02_g_cal_dict.npz
: Contains the model generated by redcal, and the baseline variances used
in the chi2 fitting.

viscatBC_stretch0.02_g_new.calfits
:  Contains the gains that were generated by redcal after fixing degeneracies. 

`bluecal` uses the model, gains, observed visibilities from the last three files to continue the calibration, and compares them to the model/gains from the first two files.

The output consists of chi2 values and plots. Examples of the plots are in bluecal_plots.pdf.


